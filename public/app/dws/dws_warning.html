<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title></title>
    <link rel="stylesheet" type="text/css" href="css/dws.css" />
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="../../../lib/extjs/ext-all.js"></script>
    <script type="text/javascript">
        window.onload = function() {
          // alert(33);
           // console.log(document.getElementById("alarm_panel"));
            var request = {
                QueryString: function(val) {
                    var uri = window.location.search;
                    var re = new RegExp("" + val + "=([^&?]*)", "ig");
                    return ((uri.match(re)) ? (uri.match(re)[0].substr(val.length + 1)) : null);
                },
                showErr: function(err, info) {
                    parent.Ext.Msg.show({
                        title: '错误',
                        msg: '生命体征报警数据' + info + '失败：' + err,
                        buttons: Ext.Msg.OK,
                        icon: Ext.Msg.ERROR
                    });
                },
                showLanErr: function(info) {
                    parent.Ext.MessageBox.alert('提示', '数据' + info + '失败,请求超时或网络故障!');
                }
            };
            //console.log(request.QueryString('PATIENT_ID'));
            var socket = io.connect(parent.webRoot);
                // 请求查询数据
                var params = [{
                    registerId:request.QueryString('PATIENT_ID')//,
                   // careTime: "2014-10-12 23:23:23"
                }];
            var  alarmText = document.getElementById("alarm_panel");
            Ext.Ajax.request({
                url: parent.webRoot + '/nws/getAnimaWarning/' + request.QueryString('PATIENT_ID'),
                method: 'GET',
                success: function (response) {
                    var reqmsg = Ext.decode(response.responseText);
                    if (reqmsg.success === true) {
                        var itemObj = reqmsg.data;
                        if(itemObj.length > 0){
                            for(var i = 0;i < itemObj.length;i++){
                                alarmText.innerHTML = alarmText.innerHTML + '<div style="color:#F00;height:19px;padding:0;margin:0;cursor:default;" title="【' +itemObj[i].name +'】 值：'+ itemObj[i].CARE_VALUE + '  时间：' +Ext.Date.format(new Date(itemObj[i].CARE_TIME), 'Y-m-d H:i') + '">【' +itemObj[i].name +'】 值：'+ itemObj[i].CARE_VALUE + '<span style="color:#4D924D;padding:0;"> 时间：' +Ext.Date.format(new Date(itemObj[i].CARE_TIME), 'Y-m-d H:i') + '</span></div>';
                            }
                        }
                    } else {
                        request.showErr(reqmsg.errors, '加载');
                    }
                }
            });
                socket.emit('careDwsAnimaWarning',params[0]);
           // var alarmText = document.getElementById("alarm_panel");
            // 接受告警信息并在页面展示
            socket.on('AnimaDwsWarningdata', function(data) {

                    var alarmDiv = document.getElementById("alarm_panel");
                   // alarmDiv =  alarmDiv.elements[0];
                    var isPlay = false;
                    if(alarmDiv!=undefined){
                    alarmDiv.innerHTML = "";
                    if(data.length > 0){
                        for(var i = 0;i < data.length;i++){
                            alarmDiv.innerHTML = alarmDiv.innerHTML + '<div style="color:#F00;height:19px;padding:0;margin:0;cursor:default;">【' +data[i].name +'】 值：'+ data[i].CARE_VALUE + '<span style="color:#4D924D;padding:0;"> 护理时间：' +Ext.Date.format(new Date(data[i].CARE_TIME), 'Y-m-d H:i') + '</span></div>';
                                }
                    }
                    if (isPlay) {
                        document.getElementById('music_warning').play();
                    }}
                });
        };
        window.onunload = function(){
          //  alert(33);
        }
    </script>
</head>
<body scroll=no style="margin: 0 0 0 0;padding: 0 0 0 0;overflow-x: hidden">
<div id="alarm_panel" class="dws-warningdiv" ></div>
<audio src="/audio/sound/warning.wav"  id="music_warning" name="music_warning"></audio >
</body>
</html>
