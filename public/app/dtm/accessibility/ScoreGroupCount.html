<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <style type="text/css">
        .html-body-overflow {
            overflow-x: hidden;
            overflow-y: hidden;
        }
    </style>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="/lib/extjs/ext-all.js"></script>
    <script type="text/javascript" src="/lib/extjs/locale/ext-lang-zh_CN.js"></script>
    <script type="text/javascript" src="/lib/extjs/ext-theme-neptune.js"></script>
    <link rel="stylesheet" type="text/css" href="/lib/extjs/resources/css/ext-all-neptune.css"/>
    <link rel="stylesheet" type="text/css" href="../../../css/common-png.css"/>
    <link rel="stylesheet" type="text/css" href="../../sys/desktop/css/desktop.css"/>
    <link rel="stylesheet" type="text/css" href="./css/accessibility.css"/>
    <script type="text/javascript">
        /*window.onresize = function () {
         };*/
        window.onload = function () {
            Ext.onReady(
                    function () {
                        var width = window.innerWidth;
                        var height = window.innerHeight;
                        var me=this;
                        me.groupStore=Ext.create('Ext.data.Store',{
                            fields:['CATEGORY','ITEM_ID','NAME','SCORES','WORK_COUNT','WORK_SCORE'],
                            proxy: {
                                type: 'ajax',
                                url: parent.webRoot + '/dtm/accessibility/query_group',
                                extraParams:{
                                    queryDate:new Date()
                                },
                                reader: {
                                    type: 'json',
                                    root: 'data'
                                }
                            },
                            listeners:{
                                load:function(){
                                    gridSum();
                                    mergeCell([2]);
                                    /*me.mergeCol([2]);
                                     me.mergeDefineCol(3,'hello world');*/
                                }
                            },
                            autoLoad: true
                        });
                        me.column=[
                            {
                                text: '序号',
                                xtype: 'rownumberer',
                                width: 40,
                                align: 'center'
                            },{ text: '分组',
                                dataIndex: 'CATEGORY',
                                style:{
                                    'text-align':'center'
                                },
                                tdCls:'dtm-grid-td',
                                width:80,
                                align:'left'
                            },{ text: '护理项目',
                                dataIndex: 'NAME',
                                style:{
                                    'text-align':'center'
                                },
                                flex:1,
                                align:'left'
                            },
                            {
                                text: '分值',
                                dataIndex: 'SCORES',
                                style:{
                                    'text-align':'center'
                                },
                                flex:1,
                                align:'right'
                            },
                            {
                                text: '工作量',
                                dataIndex: 'WORK_COUNT',
                                style:{
                                    'text-align':'center'
                                },
                                flex:1,
                                align:'right'
                            },
                            {
                                text: '工作分',
                                dataIndex: 'WORK_SCORE',
                                style:{
                                    'text-align':'center'
                                },
                                flex:1,
                                align:'right'
                            }
                        ];
                        Ext.create('Ext.grid.Panel',{
                            id: 'accessibility-score-group-grid',
                            width:width,
                            height:height,
                            renderTo: Ext.getBody(),
                            store:me.groupStore,
                            columnLines: true,
                            border: false,
                            columns: me.column,
                            dockedItems: [
                                {
                                    xtype: 'toolbar',
                                    id:'queryToolBar',
                                    dock: 'top',
                                    style:{
                                        'border-bottom':'1px solid #C0C0C0 !important'
                                    },
                                    items : ['->',
                                        {
                                            xtype : 'datefield',
                                            name : 'accessibility-count-time',
                                            id : 'accessibility-count-time',
                                            fieldLabel : '统计日期',
                                            format: 'Y-m-d',
                                            value:new Date(),
                                            width:190,
                                            editable:false,
                                            msgTarget:'none',
                                            preventMark:true,
                                            labelWidth:58,
                                            labelAlign:'right'
                                        },{
                                            xtype:'button',
                                            iconCls: 'dtm-accessibility-refresh',
                                            scale: 'small',
                                            tooltip: '查询',
                                            handler:function(btn){
                                                queryGroupCount();
                                            }
                                        },'-',{
                                            xtype:'button',
                                            iconCls: 'dtm-accessibility-print',
                                            scale: 'small',
                                            tooltip: '打印',
                                            handler:function(){
                                                printGrid();
                                            }
                                        }
                                    ]
                                },
                                {
                                    xtype:'toolbar',
                                    height:40,
                                    html:'<div style="width:100%;font-size:24px;text-align: center;font-weight:bold;">分项工作量统计表</div>'
                                }
                            ]
                            //查询

                        });

                    }
            );
        };
        function mergeCell(cols){
            var grid=Ext.getCmp('accessibility-score-group-grid');
            //==>ExtJs4.2的<tbody>改到上层<table>的lastChild . <tbody>是各个<tr>的集合
            var arrayTr = document.getElementById(grid.getId()+"-body").firstChild.firstChild.lastChild.getElementsByTagName('tr');
            var trCount = arrayTr.length;  //<tr>总行数
            var arrayTd;
            var td;
            //==>显示层将目标格的样式改为.display='none';
            var merge = function( rowspanObj , removeObjs ){//定义合并函数
                if( 0 != rowspanObj.rowspan ){
                    arrayTd = arrayTr[ rowspanObj.tr ].getElementsByTagName("td"); //合并行
                    td = arrayTd[rowspanObj.td-1];
                    td.rowSpan = rowspanObj.rowspan;
                    //td.vAlign = "middle";
                    //隐身被合并的单元格
                    Ext.each(removeObjs,function(obj){
                        arrayTd = arrayTr[obj.tr].getElementsByTagName("td");
                        arrayTd[obj.td-1].style.display='none';
                    });
                }
            };
            //==>显示层将目标格的样式改为.display='none';

            var rowspanObj = {}; //要进行跨列操作的td对象{tr:1,td:2,rowspan:5}
            var removeObjs = []; //要进行删除的td对象[{tr:2,td:2},{tr:3,td:2}]
            var col;
            //==>逐列靠表内具体数值去合并各个<tr> (表内数值一样则合并)
            Ext.each( cols , function( colIndex ){
                var rowspan = 1;
                var divHtml = null;//单元格内的数值
                for( var i=0 ; i < trCount ; i++){//==>从第一行数据0开始
                    //==>一个arrayTr[i]是一整行的所有数据, 一个arrayTd是 <td xxxx ><div>具体数值</div></td> ,
                    arrayTd = arrayTr[i].getElementsByTagName("td");
                    var cold=0;
                    col = colIndex + cold;//跳过RowNumber列和check列
                    if( !divHtml ){
                        divHtml = arrayTd[col-1].innerHTML;
                        rowspanObj = { tr:i,td:col,rowspan:rowspan }
                    }else{
                        var cellText = arrayTd[col-1].innerHTML;
                        var addf = function(){
                            rowspanObj["rowspan"] = rowspanObj["rowspan"]+1;
                            removeObjs.push({ tr:i,td:col });
                            if( i == trCount-1)
                            {
                                merge(rowspanObj,removeObjs);//执行合并函数
                            }
                        };
                        var mergef = function(){
                            merge(rowspanObj,removeObjs);//执行合并函数
                            divHtml = cellText;
                            rowspanObj = {tr:i,td:col,rowspan:rowspan}
                            removeObjs = [];
                        };
                        if( cellText == divHtml ){
                            if( colIndex != cols[0] ){
                                var leftDisplay = arrayTd[col-2].style.display;//判断左边单元格值是否已display
                                if( leftDisplay == 'none' ){
                                    addf();
                                }else{
                                    mergef();
                                }
                            }else{
                                addf();
                            }
                        }else{
                            mergef();
                        }
                    }
                }
            });
        }
        function gridSum() {
            var grid=Ext.getCmp('accessibility-score-group-grid');
            var sum1 = 0; //存储第一个列的合计值
            var sum2 = 0; //存储第二个列的合计值
            //...有几个列需要合计就声明几个变量
            grid.store.each(function (record) {              //函数grid.store.each(record))相当于一个for循环，遍历整个record
                sum1 += Number(record.data.WORK_COUNT); //把money1列下面的所有值进行加和运算
                sum2 += Number(record.data.WORK_SCORE); //把money2列下面的所有值进行加和运算
            });
            var p =
            {
                NAME:'<strong>合计</strong>',
                WORK_COUNT: '<strong>'+sum1+'</strong>',  //把money1列与合计后得到的值对应起来
                WORK_SCORE: '<strong>'+sum2+'</strong>'   //把money2列与合计后得到的值对应起来
            };
            //grid.store.insert(0, p);// 插入到当前页的第一行
            grid.store.insert(grid.getStore().getCount(), p);  //插入到当前页的最后一行，函数 grid.getStore().getCount()用来获得当前页的记录行数
        }
        function queryGroupCount(){
            var me=this;
            var date=Ext.getCmp('accessibility-count-time').getValue();
            //var grid=Ext.getCmp('accessibility-score-group-grid');
            me.groupStore.on('beforeload', function (_store, options) {
                Ext.apply(_store.proxy.extraParams, {
                    'queryDate':date
                });
            });
            me.groupStore.load();
        }
        function printGrid(){
            var me=this;
            var gridcontrol=Ext.getCmp('accessibility-score-group-grid');

            var cm = me.column;//gridcontrol.getColumnModel();
            var colCount = cm.length;
            var temp_obj = new Array();
            var colAllCount=0;
            for (var i = 0; i < colCount; i++) {
                if(cm[i].columns!=null&&cm[i].columns.length>0){
                    colAllCount+=cm[i].columns.length;
                    temp_obj=temp_obj.concat(cm[i].columns);
                }else{
                    colAllCount++;
                    temp_obj.push(cm[i]);
                }
            }
            var tableStr = '<table  style="border-top:1px black solid;border-left:1px black solid; width:100%;"cellpadding=0 cellspacing=0>';

            tableStr+='<tr><td colspan="'+colAllCount+'" style="border-right:1px black solid;border-bottom:1px black solid;font-size:24px;text-align: center;font-weight:bold;">分项工作量统计表</td></tr>';

            for (var i = 0; i < colCount; i++) {
                if(i==0){
                    tableStr = tableStr + '<tr><td style="border-right:1px black solid;border-bottom:1px black solid;text-align: center;width:40px;">' + cm[i].text + '</td>';
                }else if(i==1){
                    tableStr = tableStr + '<td style="border-right:1px black solid;border-bottom:1px black solid;text-align: center;width:80px;">' + cm[i].text + '</td>';
                }else if(i>=3){
                    tableStr = tableStr + '<td style="border-right:1px black solid;border-bottom:1px black solid;text-align: center;width:100px;">' + cm[i].text + '</td>';
                }else{
                    tableStr = tableStr + '<td style="border-right:1px black solid;border-bottom:1px black solid;text-align: center;">' + cm[i].text + '</td>';
                }

            }
            tableStr = tableStr + '</tr>';
            var arrayTr = document.getElementById("accessibility-score-group-grid-body").firstChild.firstChild.lastChild.getElementsByTagName('tr');
            for(var i=0;i<arrayTr.length;i++){
                var arryTd=arrayTr[i].getElementsByTagName("td");
                for(var j=0;j<arryTd.length;j++){
                    var td=arryTd[j];
                    if(j==0){
                        tableStr = tableStr + '<tr><td style="border-right:1px black solid;border-bottom:1px black solid;text-align: center;">' + td.innerText + '</td>';
                    }else if(j==1){
                        if(td.style.display!='none'){
                            tableStr = tableStr + '<td rowspan="'+td.rowSpan+'" style="border-right:1px black solid;border-bottom:1px black solid;">' + td.innerText + '</td>';
                        }
                    }else if(j==2){
                        tableStr = tableStr + '<td style="border-right:1px black solid;border-bottom:1px black solid;">' + td.innerText + '</td>';
                    }else{
                        tableStr = tableStr + '<td style="border-right:1px black solid;border-bottom:1px black solid;text-align: right;">' + td.innerText + '</td>';
                    }
                }
                tableStr = tableStr + '</tr>';
            }
            /*var store = gridcontrol.getStore();
            var recordCount = store.getCount();
            for (var i = 0; i < recordCount; i++) {
                var r = store.getAt(i);
                for (var j = 0; j < temp_obj.length; j++) {
                    var dateIndex = temp_obj[j].dataIndex;
                    var tdvalue = r.get(dateIndex);
                    if (tdvalue == null) {
                        tdvalue = '';
                    }
                    if(j==0){
                        tableStr = tableStr + '<td style="border-right:1px black solid;border-bottom:1px black solid;text-align: center;">' + (i+1) + '</td>';
                    }else if(j==1||j==2){
                        tableStr = tableStr + '<td style="border-right:1px black solid;border-bottom:1px black solid;">' + tdvalue + '</td>';
                    }else{
                        tableStr = tableStr + '<td style="border-right:1px black solid;border-bottom:1px black solid;text-align: right;">' + tdvalue + '</td>';
                    }
                }
                tableStr = tableStr + '</tr>';
            }*/
            tableStr = tableStr + '</table>';
            var titleHtml = tableStr;
            var newwin = window.open('printer.html', '', '');
            newwin.document.write(titleHtml);
            newwin.document.location.reload();
            newwin.print();
            newwin.close();
        }
        /*function printGrid(){
            document.getElementById('queryToolBar').style.display="none";
            var grid=Ext.getCmp('accessibility-score-group-grid');
            //==>ExtJs4.2的<tbody>改到上层<table>的lastChild . <tbody>是各个<tr>的集合
            var arrayTr = document.getElementById(grid.getId()+"-body").firstChild.firstChild.lastChild.getElementsByTagName('tr');
            var arrayTd;
            for(var i=0;i<arrayTr.length;i++){
                arrayTd = arrayTr[i].getElementsByTagName("td");
                arrayTd[0].style.borderLeft="1px solid #EDEDED";
            }
            window.print();
            document.getElementById('queryToolBar').style.display="block";
        }*/
    </script>
</head>
<body>
</body>
</html>